version: "3.8"

services:
  server:
    build:
      context: ..
      dockerfile: docker/Dockerfile.server
    ports:
      - "3100:3100"
    volumes:
      - workspaces:/var/pocket-code/workspaces
      - /var/run/docker.sock:/var/run/docker.sock  # Docker-in-Docker for sandbox containers
    environment:
      - PORT=3100
      - WORKSPACE_ROOT=/var/pocket-code/workspaces
      - DOCKER_ENABLED=true
      - SANDBOX_IMAGE=pocket-code-sandbox:latest
      - JWT_SECRET=${JWT_SECRET:?Set JWT_SECRET in .env}
      - JWT_EXPIRES_IN=30d
      - SILICONFLOW_API_KEY=${SILICONFLOW_API_KEY:-}
      - SILICONFLOW_BASE_URL=${SILICONFLOW_BASE_URL:-https://api.siliconflow.cn/v1}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - GOOGLE_GENERATIVE_AI_API_KEY=${GOOGLE_GENERATIVE_AI_API_KEY:-}
    restart: unless-stopped

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - certbot-etc:/etc/letsencrypt:ro
      - certbot-var:/var/lib/letsencrypt
    depends_on:
      - server
    restart: unless-stopped

  # SSL certificate management
  certbot:
    image: certbot/certbot
    volumes:
      - certbot-etc:/etc/letsencrypt
      - certbot-var:/var/lib/letsencrypt
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do sleep 12h & wait $${!}; certbot renew; done'"

volumes:
  workspaces:
  certbot-etc:
  certbot-var:
